
# Dify工作流配置 - 分步实操指南

> **预计完成时间：** 15-20分钟  
> **前提条件：** API服务运行中 (http://localhost:5000)

---

## 🎯 配置路线图

我们将按以下顺序配置：

```
1. 工作流3：知识问答助手 (最简单，5分钟) ✓
   ↓
2. 工作流2：智能教案生成 (中等，5分钟) ✓
   ↓
3. 工作流1：文档知识蒸馏 (稍复杂，10分钟) ✓
```

**为什么这样排序？**
- 从简单到复杂，循序渐进
- 先测试RAG检索核心功能
- 最后配置文档上传（涉及文件处理）

---

## 📝 配置前检查

### ✅ 第1步：确认API服务状态

**在PowerShell中运行：**
```powershell
# 测试API健康状态
Invoke-RestMethod -Uri http://localhost:5000/health

# 查看知识库统计
Invoke-RestMethod -Uri http://localhost:5000/api/knowledge/stats
```

**预期输出：**
```json
{
  "status": "ok",
  "knowledge_count": 95,
  "vector_shape": [95, 1024]
}
```

**如果失败：**
- 检查API服务是否运行：`netstat -ano | findstr :5000`
- 重新启动：`cd C:\Users\27844\llamafactory_workspace\dify_integration && python dify_knowledge_api.py`

---

### ✅ 第2步：访问Dify工作流编辑器

1. 打开浏览器，访问您的Dify地址（例如 `http://localhost` 或 `http://localhost:3000`）
2. 登录Dify账号
3. 进入 **"工作室"** → **"工作流"**
4. 确认可以创建新工作流

**截图位置：** 请确认您能看到 "创建工作流" 按钮

---

## 🤖 工作流1：知识问答助手（从这个开始！）

### 为什么先配置这个？
- **最简单**：只需3个节点
- **测试核心功能**：验证RAG检索是否正常
- **立即可用**：配置完就能问答

---

### 📋 详细配置步骤

#### Step 1.1：创建工作流
1. 点击 **"创建工作流"**
2. 选择类型：**"聊天助手"** 或 **"对话式应用"**
3. 工作流名称：`CS知识问答助手`
4. 描述：`基于95条CS知识库的智能问答系统`

---

#### Step 1.2：配置开始节点

**节点名称：** `开始` (系统自动创建)

**输入变量配置：**
- 变量名：`query`
- 类型：**文本 (Text)**
- 是否必填：✅ 是
- 默认值：（留空）
- 描述：`用户的问题`

**界面提示：**
```
示例问题：
- 什么是快速排序的时间复杂度？
- TCP和UDP有什么区别？
- 解释一下进程和线程的区别
```

---

#### Step 1.3：添加HTTP请求节点

**操作：** 点击 **"+"** → 选择 **"HTTP请求"**

**节点配置：**

| 配置项 | 值 |
|--------|-----|
| **节点名称** | `RAG知识检索` |
| **请求方法** | `POST` |
| **URL** | `http://localhost:5000/api/search` |
| **请求头** | Content-Type: `application/json` |
| **超时时间** | `10` 秒 |

**请求体配置（重要！）：**

选择 **"JSON"** 格式，输入：

```json
{
  "query": "{{#开始.query#}}",
  "top_k": 3
}
```

**变量引用说明：**
- `{{#开始.query#}}` 表示引用"开始"节点的`query`变量
- Dify语法：`{{#节点名.变量名#}}`

**完成标志：** 节点右上角显示 ✓ 无错误提示

---

#### Step 1.4：添加条件判断节点

**操作：** 点击 **"+"** → 选择 **"条件判断"** (IF/ELSE)

**节点配置：**

| 配置项 | 值 |
|--------|-----|
| **节点名称** | `检查是否有结果` |
| **条件类型** | `判断表达式` |

**条件设置（关键！）：**

**IF分支（有结果）：**
```
条件：{{#RAG知识检索.body.results#}} 不为空
或者：length({{#RAG知识检索.body.results#}}) > 0
```

**ELSE分支（无结果）：**
- 自动生成，无需配置

**Dify界面操作：**
1. 点击 "添加条件"
2. 变量：选择 `RAG知识检索.body.results`
3. 判断类型：`不为空` 或 `长度大于 0`

---

#### Step 1.5：添加LLM节点（IF分支 - 有结果）

**操作：** 在 **IF分支** 下点击 **"+"** → 选择 **"LLM"**

**节点配置：**

| 配置项 | 值 |
|--------|-----|
| **节点名称** | `基于知识库回答` |
| **模型** | 选择您的LLM（GPT-4/Claude/通义千问等） |
| **温度** | `0.3` (更精确的回答) |
| **最大Token** | `1000` |

**系统提示词（System Prompt）：**
```
你是一个专业的计算机科学助教，专注于数据结构、算法、操作系统、计算机网络和数据库知识。

你的任务：
1. 基于提供的知识库内容回答用户问题
2. 答案必须准确，不要编造信息
3. 如果知识库没有完全覆盖问题，请明确说明
4. 用简洁易懂的语言解释技术概念
5. 必要时举例说明，帮助理解

回答格式要求：
- 先给出核心答案（2-3句话）
- 再展开详细解释
- 如果有相关知识点，可以适当扩展
```

**用户提示词（User Prompt）：**
```
用户问题：{{#开始.query#}}

知识库检索结果（按相似度排序）：

{{#RAG知识检索.body.results#}}

请基于以上知识库内容，回答用户的问题。如果知识库中的内容不足以完整回答，请说明需要补充哪些信息。
```

**变量引用提示：**
- Dify会自动格式化 `results` 数组
- 如果需要自定义格式，使用Jinja2模板

---

#### Step 1.6：添加直接回复节点（ELSE分支 - 无结果）

**操作：** 在 **ELSE分支** 下点击 **"+"** → 选择 **"直接回复"**

**节点配置：**

| 配置项 | 值 |
|--------|-----|
| **节点名称** | `无结果提示` |
| **回复内容** | 见下方 |

**回复内容：**
```
抱歉，我在当前知识库中没有找到与"{{#开始.query#}}"直接相关的内容。

当前知识库覆盖范围：
• 数据结构与算法（排序、搜索、树、图等）
• 操作系统（进程、线程、内存管理等）
• 计算机网络（TCP/IP、HTTP、网络层次等）
• 数据库（SQL、事务、索引等）

建议：
1. 尝试换一种方式提问，例如：
   - "什么是快速排序？" 而不是 "快排"
   - "TCP和UDP的区别" 而不是 "网络协议"

2. 查看知识库统计确认覆盖范围：
   http://localhost:5000/api/knowledge/stats

3. 如果需要，可以上传相关文档补充知识库

您可以继续提问其他问题！
```

---

#### Step 1.7：汇总节点 - 最终回复

**操作：** 添加 **"直接回复"** 节点，连接IF和ELSE两个分支

**节点配置：**

| 配置项 | 值 |
|--------|-----|
| **节点名称** | `最终回复` |
| **回复内容** | 见下方 |

**回复内容（动态选择）：**
```
{{#基于知识库回答.text#}}{{#无结果提示.output#}}
```

**说明：**
- 如果IF分支执行，显示LLM回答
- 如果ELSE分支执行，显示无结果提示
- Dify会自动选择非空的输出

---

#### Step 1.8：连接所有节点

**连接关系：**
```
开始 → HTTP请求(RAG知识检索) → 条件判断(检查是否有结果)
                                    ├─ IF(有结果) → LLM(基于知识库回答) ┐
                                    └─ ELSE(无结果) → 直接回复(无结果提示) ┘
                                                                         ↓
                                                                    最终回复
```

**Dify操作：**
1. 鼠标悬停在节点右侧，出现连接点
2. 拖动连接线到下一个节点
3. 确保所有节点都连接正确

---

#### Step 1.9：测试工作流

**操作：** 点击右上角 **"测试运行"** 或 **"调试"**

**测试用例1（有结果）：**
```
输入：什么是快速排序的时间复杂度？
预期：返回相关知识点，说明平均O(n log n)，最坏O(n²)
```

**测试用例2（无结果）：**
```
输入：什么是量子计算？
预期：提示知识库中没有相关内容
```

**调试技巧：**
1. 点击每个节点查看输入/输出
2. 检查HTTP请求返回的 `results` 数组
3. 查看LLM节点的完整Prompt
4. 如果出错，查看节点的错误信息

---

#### Step 1.10：发布工作流

**如果测试通过：**
1. 点击右上角 **"发布"**
2. 选择发布位置（应用/API）
3. 复制工作流URL或API密钥
4. 开始使用！

**如果测试失败，常见问题：**

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| HTTP请求超时 | API服务未运行 | 检查 `http://localhost:5000/health` |
| 变量引用错误 | Dify语法错误 | 确保使用 `{{#节点名.变量名#}}` |
| LLM无响应 | 模型配置错误 | 检查LLM模型是否可用 |
| 条件判断失败 | 条件表达式错误 | 使用 `不为空` 或 `长度 > 0` |

---

## 🎓 工作流2：智能教案生成

### 配置难度：⭐⭐⭐ (中等)

---

### 📋 详细配置步骤

#### Step 2.1：创建工作流
1. 点击 **"创建工作流"**
2. 类型：**"聊天助手"**
3. 名称：`智能教案生成器`
4. 描述：`基于RAG检索自动生成结构化教学方案`

---

#### Step 2.2：配置开始节点

**输入变量：**

| 变量名 | 类型 | 必填 | 默认值 | 描述 |
|--------|------|------|--------|------|
| `topic` | 文本 | ✅ | - | 教学主题 |
| `top_k` | 数字 | ❌ | `5` | 检索知识点数量 |

**界面提示：**
```
教学主题示例：
- 快速排序算法
- TCP三次握手原理
- 数据库索引优化
- 进程调度算法
```

---

#### Step 2.3：添加HTTP请求节点

**节点配置：**

| 配置项 | 值 |
|--------|-----|
| **节点名称** | `获取教案知识点` |
| **请求方法** | `POST` |
| **URL** | `http://localhost:5000/api/generate_lesson_plan` |
| **请求头** | Content-Type: `application/json` |
| **超时时间** | `30` 秒 |

**请求体（JSON）：**
```json
{
  "topic": "{{#开始.topic#}}",
  "top_k": {{#开始.top_k#}}
}
```

**注意：** `top_k` 是数字，不需要引号

---

#### Step 2.4：添加LLM节点 - 生成教案

**节点配置：**

| 配置项 | 值 |
|--------|-----|
| **节点名称** | `生成结构化教案` |
| **模型** | GPT-4 或 Claude（推荐） |
| **温度** | `0.5` |
| **最大Token** | `2000` |

**系统提示词：**
```
你是一位经验丰富的计算机科学教师，擅长设计结构化的教学方案。

你的任务是根据提供的知识点，生成一份完整的教案。

教案必须包含以下部分：

## 1. 教学目标
- 知识目标（3-4条）
- 能力目标（2-3条）
- 情感态度目标（1-2条）

## 2. 教学重点与难点
- 教学重点（2-3个）
- 教学难点（2-3个）
- 突破策略

## 3. 知识点讲解（核心部分）
- 按照逻辑顺序组织知识点
- 每个知识点包含：概念、原理、示例
- 使用图表、代码等辅助说明

## 4. 实际应用场景
- 真实案例（2-3个）
- 应用价值说明

## 5. 常见问题与解答
- 学生常问的3-5个问题
- 每个问题的详细解答

## 6. 练习题推荐
- 基础题（2-3题）
- 进阶题（1-2题）
- 综合应用题（1题）

## 7. 教学建议
- 课时安排
- 教学方法
- 注意事项

使用Markdown格式输出，层次清晰，逻辑严密。
```

**用户提示词：**
```
教学主题：{{#开始.topic#}}

系统已检索到以下相关知识点（按相似度排序）：

{{#获取教案知识点.body.knowledge_items#}}

请基于这些知识点，生成一份完整的、结构化的教学方案。

要求：
1. 必须涵盖上述所有知识点
2. 知识点讲解要深入浅出
3. 例子要贴近实际应用
4. 练习题要有层次性
5. 总篇幅控制在2000字左右

开始生成教案：
```

---

#### Step 2.5：添加直接回复节点

**节点配置：**

| 配置项 | 值 |
|--------|-----|
| **节点名称** | `返回教案` |
| **回复内容** | `{{#生成结构化教案.text#}}` |

---

#### Step 2.6：连接节点

**连接关系：**
```
开始 → HTTP请求(获取教案知识点) → LLM(生成结构化教案) → 直接回复(返回教案)
```

---

#### Step 2.7：测试工作流

**测试用例：**
```
输入：
  topic: "快速排序算法"
  top_k: 5

预期输出：
- 完整的Markdown格式教案
- 包含7个主要部分
- 引用至少5个相关知识点
- 总长度约2000字
```

---

## 📄 工作流3：文档实时知识蒸馏

### 配置难度：⭐⭐⭐⭐ (稍复杂)

---

### 📋 详细配置步骤

#### Step 3.1：创建工作流
1. 类型：**"工作流应用"** 或 **"表单应用"**
2. 名称：`文档知识蒸馏`
3. 描述：`上传文档自动提取知识点并存入知识库`

**为什么选择"工作流应用"？**
- 支持文件上传
- 可以配置多个输入字段
- 适合复杂处理流程

---

#### Step 3.2：配置开始节点

**输入变量：**

| 变量名 | 类型 | 必填 | 默认值 | 描述 |
|--------|------|------|--------|------|
| `file` | **文件** | ✅ | - | 待蒸馏文档 |
| `category` | **下拉选择** | ✅ | - | 知识类别 |
| `auto_distill` | **开关** | ❌ | `true` | 是否自动蒸馏 |

**category下拉选项：**
```
- algorithms: 算法与数据结构
- database: 数据库
- network: 计算机网络
- os: 操作系统
- ai: 人工智能
- general: 通用知识
```

---

#### Step 3.3：添加HTTP请求节点

**⚠️ 重要：** 文件上传需要使用 `multipart/form-data`

**节点配置：**

| 配置项 | 值 |
|--------|-----|
| **节点名称** | `上传文档到API` |
| **请求方法** | `POST` |
| **URL** | `http://localhost:5000/api/upload_document` |
| **请求类型** | `multipart/form-data` |
| **超时时间** | `60` 秒 |

**请求体（Multipart表单）：**

在Dify中，配置表单字段：

| 字段名 | 类型 | 值 |
|--------|------|-----|
| `file` | 文件 | `{{#开始.file#}}` |
| `category` | 文本 | `{{#开始.category#}}` |
| `auto_distill` | 文本 | `{{#开始.auto_distill#}}` |

**Dify界面操作：**
1. 请求类型选择 `multipart/form-data`
2. 点击 "添加表单字段"
3. 依次添加上述3个字段
4. 确保文件字段引用正确

---

#### Step 3.4：添加条件判断节点

**节点配置：**

| 配置项 | 值 |
|--------|-----|
| **节点名称** | `检查蒸馏结果` |
| **条件类型** | 判断表达式 |

**条件设置：**

**IF分支（成功）：**
```
条件：{{#上传文档到API.status_code#}} == 200
或者：{{#上传文档到API.body.new_knowledge_count#}} > 0
```

**ELSE分支（失败）：**
- 自动生成

---

#### Step 3.5：添加LLM节点（IF分支 - 蒸馏成功）

**节点配置：**

| 配置项 | 值 |
|--------|-----|
| **节点名称** | `生成蒸馏报告` |
| **模型** | 您的LLM |
| **温度** | `0.3` |
| **最大Token** | `800` |

**系统提示词：**
```
你是一个知识管理助手。用户上传了一个文档，系统已经自动提取了知识点。

你的任务是生成一份简洁的总结报告（200字以内）。

报告格式：
1. 文档概况（1句话）
2. 提取知识点数量和类别
3. 知识点质量评价（简要）
4. 下一步建议（可选）

语言风格：专业、简洁、友好
```

**用户提示词：**
```
文档蒸馏完成！

上传文档：{{#上传文档到API.body.file_name#}}
知识类别：{{#上传文档到API.body.category#}}
新增知识点：{{#上传文档到API.body.new_knowledge_count#}} 条
知识库总数：{{#上传文档到API.body.total_count#}} 条

提取的知识点预览：
{{#上传文档到API.body.knowledge_items#}}

请生成一份简洁的总结报告。
```

---

#### Step 3.6：添加直接回复节点（ELSE分支 - 失败）

**节点配置：**

| 配置项 | 值 |
|--------|-----|
| **节点名称** | `错误提示` |
| **回复内容** | 见下方 |

**回复内容：**
```
❌ 文档上传或蒸馏失败

可能原因：
1. 文档格式不支持（当前支持：TXT、PDF、DOCX、MD）
2. 文档内容为空或无法解析
3. API服务异常

错误详情：
{{#上传文档到API.body.error#}}

建议：
1. 检查文档格式和内容
2. 确认API服务运行正常：http://localhost:5000/health
3. 查看API日志获取详细错误信息
4. 如果问题持续，请联系技术支持

您可以尝试上传其他文档。
```

---

#### Step 3.7：汇总节点 - 最终回复

**节点配置：**

| 配置项 | 值 |
|--------|-----|
| **节点名称** | `返回结果` |
| **回复内容** | `{{#生成蒸馏报告.text#}}{{#错误提示.output#}}` |

---

#### Step 3.8：连接节点

**连接关系：**
```
开始 → HTTP请求(上传文档到API) → 条件判断(检查蒸馏结果)
                                    ├─ IF(成功) → LLM(生成蒸馏报告) ┐
                                    └─ ELSE(失败) → 直接回复(错误提示) ┘
                                                                     ↓
                                                                 返回结果
```

---

#### Step 3.9：测试工作流

**测试用例：**

创建测试文件 `test_algorithm.txt`：
```
快速排序是一种高效的排序算法，采用分治策略。

基本原理：
1. 选择一个基准元素（pivot）
2. 将数组分为两部分：小于基准和大于基准
3. 递归地对两部分进行快速排序

时间复杂度：
- 平均情况：O(n log n)
- 最坏情况：O(n²) （当数组已排序时）
- 最好情况：O(n log n)

空间复杂度：O(log n)（递归栈）

适用场景：
- 大规模数据排序
- 需要原地排序的场景
- 对平均性能要求高的场合
```

**上传测试：**
```
文件：test_algorithm.txt
类别：algorithms
自动蒸馏：true

预期输出：
- 成功提取5个知识点
- 知识库总数变为100条
- 返回简洁的总结报告
```

---

## ✅ 配置完成检查清单

### 工作流1：知识问答助手
- [ ] 节点连接正确（开始 → HTTP → 条件 → LLM/直接回复 → 最终回复）
- [ ] HTTP请求URL正确：`http://localhost:5000/api/search`
- [ ] 请求体JSON格式正确
- [ ] LLM系统提示词完整
- [ ] 测试通过（有结果和无结果两种情况）
- [ ] 已发布并可用

### 工作流2：智能教案生成
- [ ] 节点连接正确（开始 → HTTP → LLM → 直接回复）
- [ ] HTTP请求URL正确：`http://localhost:5000/api/generate_lesson_plan`
- [ ] top_k参数引用正确（数字类型，无引号）
- [ ] LLM提示词包含7部分教案结构
- [ ] 测试通过，生成完整教案
- [ ] 已发布并可用

### 工作流3：文档知识蒸馏
- [ ] 节点连接正确（开始 → HTTP → 条件 → LLM/直接回复 → 返回结果）
- [ ] HTTP请求类型为 `multipart/form-data`
- [ ] 文件字段引用正确
- [ ] category下拉选项配置完整
- [ ] 条件判断逻辑正确
- [ ] 测试通过（成功和失败两种情况）
- [ ] 已发布并可用

---

## 🎯 完整测试流程

### 测试1：知识问答
```
1. 打开"CS知识问答助手"
2. 输入："什么是快速排序的时间复杂度？"
3. 预期：返回详细答案，相似度 > 0.8
4. 输入："什么是量子计算？"
5. 预期：提示知识库中无相关内容
```

### 测试2：教案生成
```
1. 打开"智能教案生成器"
2. 输入主题："快速排序算法"
3. top_k：5
4. 预期：返回结构化Markdown教案，包含7个部分
5. 检查是否引用了5条知识点
```

### 测试3：文档蒸馏
```
1. 打开"文档知识蒸馏"
2. 上传测试文件（见上面的test_algorithm.txt）
3. 类别：algorithms
4. 自动蒸馏：true
5. 预期：提取5个知识点，返回总结报告
6. 运行测试1再次测试，应该能检索到新知识
```

---

## 🔧 常见问题解决

### 问题1：HTTP请求失败
**错误信息：** "Connection refused" 或 "Timeout"

**解决步骤：**
```powershell
# 1. 检查API服务状态
netstat -ano | findstr :5000

# 2. 如果没有运行，启动服务
cd C:\Users\27844\llamafactory_workspace\dify_integration
python dify_knowledge_api.py

# 3. 验证服务
Invoke-RestMethod -Uri http://localhost:5000/health
```

---

### 问题2：变量引用错误
**错误信息：** "Variable not found" 或 显示 `{{#xxx#}}`

**原因：** Dify变量语法错误

**正确语法：**
```
{{#节点名称.变量名#}}

例如：
{{#开始.query#}}              ✓ 正确
{{开始.query}}                ✗ 错误（缺少#）
{{#start.query#}}             ✗ 错误（节点名不对）
```

---

### 问题3：条件判断不生效
**症状：** 总是走同一个分支

**检查：**
1. 条件表达式是否正确
2. HTTP响应数据结构是否匹配
3. 使用调试模式查看实际返回值

**正确配置：**
```
IF条件：{{#HTTP节点.body.results#}} 不为空
或者：length({{#HTTP节点.body.results#}}) > 0
```

---

### 问题4：文件上传失败
**症状：** 工作流3上传文件报错

**检查清单：**
1. [ ] HTTP请求类型是 `multipart/form-data`
2. [ ] 文件字段名为 `file`（与API匹配）
3. [ ] 文件大小 < 10MB
4. [ ] 文件格式支持（TXT/PDF/DOCX/MD）

---

### 问题5：LLM返回质量差
**症状：** 回答不准确或格式混乱

**优化方案：**
1. **降低温度**：0.3-0.5（更精确）
2. **优化系统提示词**：更明确的要求和格式
3. **增加示例**：在提示词中提供few-shot示例
4. **调整top_k**：获取更多上下文

---

## 📊 性能监控

### 监控指标

| 指标 | 正常值 | 说明 |
|------|--------|------|
| HTTP请求延迟 | < 2秒 | RAG检索速度 |
| LLM响应时间 | < 10秒 | 生成速度 |
| 文档蒸馏时间 | < 30秒 | 上传+处理 |
| API成功率 | > 95% | 服务稳定性 |

### 查看API日志

**在运行API服务的控制台：**
```
INFO:     127.0.0.1 - "POST /api/search HTTP/1.1" 200 OK
INFO:     检索查询: 什么是快速排序？
INFO:     找到 3 条相关知识，最高相似度: 0.8972
```

---

## 🎉 配置完成！

恭喜您成功配置了3个Dify工作流！

**当前系统能力：**
✅ 知识问答：95条CS知识库支撑
✅ 教案生成：结构化教学方案
✅ 文档蒸馏：实时扩展知识库

**下一步建议：**
1. 持续上传专业文档扩充知识库
2. 收集用户反馈优化提示词
3. 调整RAG检索参数（top_k、相似度阈值）
4. 探索更多应用场景（作业批改、课程推荐等）

**如有问题，随时反馈！🚀**
